<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IM Platform</title>
  </head>
  <body>
    <!-- Login and Registration Forms -->
    <div id="auth-section">
      <div>
        <input type="text" id="login-username" placeholder="Username" />
        <input type="password" id="login-password" placeholder="Password" />
        <button onclick="login()">Login</button>
      </div>
      <div>
        <input type="text" id="register-username" placeholder="Username" />
        <input type="password" id="register-password" placeholder="Password" />
        <button onclick="register()">Register</button>
      </div>
    </div>

    <!-- Chat Section -->
    <div id="chat-section" style="display: none">
      <div>
        <h2>Online Users</h2>
        <ul id="online-users"></ul>
      </div>
      <div>
        <h2>Messages</h2>
        <ul id="messages"></ul>
        <input type="text" id="message-input" placeholder="Type a message" />
        <button onclick="sendMessage()">Send</button>
      </div>
      <button id="logout-button">Logout</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      let token = null;
      let currentUsername = null; // Store the current username

      function login() {
        const username = document.getElementById("login-username").value;
        const password = document.getElementById("login-password").value;
        fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        })
          .then((response) => response.json())
          .then((data) => {
            token = data.accessToken;
            currentUsername = username; // Store the username
            document.getElementById("auth-section").style.display = "none";
            document.getElementById("chat-section").style.display = "block";
            initializeChat();
          })
          .catch((error) => console.error("Error:", error));
      }

      function register() {
        const username = document.getElementById("register-username").value;
        const password = document.getElementById("register-password").value;
        fetch("/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        })
          .then((response) => response.text())
          .then((data) => {
            alert(data);
            currentUsername = username; // Store the username
            document.getElementById("auth-section").style.display = "none";
            document.getElementById("chat-section").style.display = "block";
            initializeChat();
          })
          .catch((error) => console.error("Error:", error));
      }

      function initializeChat() {
        const socket = io({ query: { token } });

        function sendMessage() {
          const message = document.getElementById("message-input").value;
          socket.emit("send-message", { username: currentUsername, message }); // Include the username
          document.getElementById("message-input").value = "";
        }

        socket.on("online-users", (users) => {
          const usersList = document.getElementById("online-users");
          usersList.innerHTML = "";
          users.forEach((user) => {
            const userElement = document.createElement("li");
            userElement.textContent = user;
            usersList.appendChild(userElement);
          });
        });

        socket.on("receive-message", (data) => {
          const messagesList = document.getElementById("messages");
          const messageElement = document.createElement("li");
          messageElement.textContent = `${data.username}: ${data.message}`;
          messagesList.appendChild(messageElement);
        });

        window.sendMessage = sendMessage;
      }

      document.addEventListener("DOMContentLoaded", () => {
        const cookies = document.cookie.split("; ");
        const tokenCookie = cookies.find((row) => row.startsWith("token="));
        if (tokenCookie) {
          token = tokenCookie.split("=")[1];
          document.getElementById("auth-section").style.display = "none";
          document.getElementById("chat-section").style.display = "block";
          initializeChat();
        }
      });

      function logout() {
        fetch("/logout", {
          method: "POST",
        })
          .then(() => {
            document.getElementById("auth-section").style.display = "block";
            document.getElementById("chat-section").style.display = "none";
            token = null;
          })
          .catch((error) => console.error("Error:", error));
      }

      document.getElementById("logout-button").onclick = logout;
    </script>
  </body>
</html>
